<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø±Ø¯Ø´Ø© ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #startScreen {
            display: block;
        }

        .permission-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .permission-item {
            color: white;
            font-size: 1.2em;
            margin: 15px 0;
            text-align: right;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .btn-start {
            width: 100%;
            padding: 20px;
            font-size: 1.5em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .btn-start:hover {
            transform: scale(1.02);
        }

        .btn-start:active {
            transform: scale(0.98);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† */
        #colorScreen {
            display: none;
        }

        .color-title {
            color: white;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .btn-color {
            width: 100%;
            padding: 25px;
            font-size: 1.8em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
            color: white;
            transition: transform 0.2s;
        }

        .btn-red {
            background: linear-gradient(135deg, #cb2d3e, #ef473a);
        }

        .btn-blue {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }

        .btn-color:hover {
            transform: scale(1.02);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        #videoScreen {
            display: none;
        }

        .video-box {
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
            width: 100%;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .video-box video {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
            min-height: 200px;
            transform: scaleX(-1);
        }

        .label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1.1em;
            z-index: 10;
            font-weight: bold;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .waiting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.3em;
            z-index: 5;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .control-btn {
            flex: 1;
            min-width: 100px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        .exit-btn {
            background: #ff4e50;
            color: white;
        }

        .message {
            color: white;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-size: 1.1em;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .error-message {
            color: #ff6b6b;
            background: rgba(255,0,0,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ Ø¯Ø±Ø¯Ø´Ø© ÙÙŠØ¯ÙŠÙˆ</h1>
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© - Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
        <div id="startScreen">
            <div class="permission-box">
                <div class="permission-item">ğŸ”´ Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ</div>
                <div class="permission-item">ğŸ“¹ Ù†Ø­ØªØ§Ø¬ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
                <div class="permission-item">ğŸ¤ Ù†Ø­ØªØ§Ø¬ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
            </div>
            
            <button class="btn-start" onclick="requestPermissions()">
                â–¶ï¸ Ø§Ø¶ØºØ· Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
            </button>
            
            <div id="startMessage" class="message"></div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† -->
        <div id="colorScreen">
            <div class="color-title">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ùƒ</div>
            <button class="btn-color btn-red" onclick="selectColor('red')">ğŸ”´ Ø£Ù†Ø§ Ø£Ø­Ù…Ø±</button>
            <button class="btn-color btn-blue" onclick="selectColor('blue')">ğŸ”µ Ø£Ù†Ø§ Ø£Ø²Ø±Ù‚</button>
            <div id="colorMessage" class="message"></div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
        <div id="videoScreen">
            <div class="video-box">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="label" id="localLabel">Ø£Ù†Ø§</div>
                <div class="waiting-overlay" id="localWaiting" style="display: none;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
            
            <div class="video-box">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="label" id="remoteLabel">Ø§Ù„Ø¢Ø®Ø±</div>
                <div class="waiting-overlay" id="remoteWaiting">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±</div>
            </div>
            
            <div class="controls">
                <button class="control-btn" onclick="toggleAudio()" id="audioBtn">ğŸ”Š ÙƒØªÙ…</button>
                <button class="control-btn" onclick="toggleVideo()" id="videoBtn">ğŸ“¹ Ø¥ÙŠÙ‚Ø§Ù</button>
                <button class="control-btn exit-btn" onclick="exitToStart()">ğŸ  Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <div id="videoMessage" class="message"></div>
        </div>
    </div>

    <!-- Firebase ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.0/simple-peer.min.js"></script>
    
    <script>
        // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB3rEMVnYFDc36O3vZukFbRllAHAbZeNs8",
            authDomain: "maa27-c17ae.firebaseapp.com",
            projectId: "maa27-c17ae",
            storageBucket: "maa27-c17ae.firebasestorage.app",
            messagingSenderId: "683343880694",
            appId: "1:683343880694:web:928a9355e7e9471dde67d7"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
        let localStream = null;      // ØªÙŠØ§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ
        let currentUser = null;      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (red Ø£Ùˆ blue)
        let peer = null;             // Ø§ØªØµØ§Ù„ Peer
        let roomListener = null;     // Ù…Ø³ØªÙ…Ø¹ Firebase
        let isAudioEnabled = true;    // Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª
        let isVideoEnabled = true;    // Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        
        const ROOM_ID = "video-chat-room-2024";  // Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø«Ø§Ø¨Øª

        // ========== Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ==========
        async function requestPermissions() {
            const messageEl = document.getElementById('startMessage');
            messageEl.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...';
            
            try {
                // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'  // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                    }, 
                    audio: true 
                });
                
                messageEl.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!';
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    document.getElementById('startScreen').style.display = 'none';
                    document.getElementById('colorScreen').style.display = 'block';
                    document.getElementById('colorMessage').innerHTML = '';
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', error);
                
                let errorText = 'âŒ Ø®Ø·Ø£: ' + error.message;
                if (error.name === 'NotAllowedError') {
                    errorText = 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
                } else if (error.name === 'NotFoundError') {
                    errorText = 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªØµÙ„';
                }
                
                messageEl.innerHTML = `<div class="error-message">${errorText}</div>`;
                localStream = null;  // ØªØ£ÙƒÙŠØ¯ Ø£Ù† localStream = null
            }
        }

        // ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† ==========
        async function selectColor(color) {
            if (!localStream) {
                document.getElementById('colorMessage').innerHTML = '<div class="error-message">âŒ ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙˆÙ„Ø§Ù‹</div>';
                return;
            }
            
            currentUser = color;
            document.getElementById('colorMessage').innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
            
            try {
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
                document.getElementById('colorScreen').style.display = 'none';
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                document.getElementById('videoScreen').style.display = 'block';
                
                // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù†
                const localLabel = document.getElementById('localLabel');
                localLabel.className = 'label';
                localLabel.style.background = color === 'red' ? 
                    'linear-gradient(135deg, #cb2d3e, #ef473a)' : 
                    'linear-gradient(135deg, #1e3c72, #2a5298)';
                localLabel.innerHTML = color === 'red' ? 'ğŸ”´ Ø£Ù†Ø§' : 'ğŸ”µ Ø£Ù†Ø§';
                
                const remoteLabel = document.getElementById('remoteLabel');
                remoteLabel.style.background = color === 'red' ? 
                    'linear-gradient(135deg, #1e3c72, #2a5298)' : 
                    'linear-gradient(135deg, #cb2d3e, #ef473a)';
                remoteLabel.innerHTML = color === 'red' ? 'ğŸ”µ Ø§Ù„Ø¢Ø®Ø±' : 'ğŸ”´ Ø§Ù„Ø¢Ø®Ø±';
                
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                document.getElementById('localWaiting').style.display = 'none';
                
                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firebase
                await setupRoom();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ†:', error);
                document.getElementById('colorMessage').innerHTML = '<div class="error-message">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message + '</div>';
            }
        }

        // ========== ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØºØ±ÙØ© ==========
        async function setupRoom() {
            const roomRef = db.collection('rooms').doc(ROOM_ID);
            
            try {
                const doc = await roomRef.get();
                
                if (!doc.exists) {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
                    await roomRef.set({
                        red: currentUser === 'red' ? 'waiting' : null,
                        blue: currentUser === 'blue' ? 'waiting' : null,
                        created: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                    await roomRef.update({
                        [currentUser]: 'waiting'
                    });
                }
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
                listenToRoom();
                
                document.getElementById('videoMessage').innerHTML = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±...';
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØºØ±ÙØ©:', error);
                document.getElementById('videoMessage').innerHTML = '<div class="error-message">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
            }
        }

        // ========== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ© ==========
        function listenToRoom() {
            const roomRef = db.collection('rooms').doc(ROOM_ID);
            
            roomListener = roomRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±
                    const otherUser = currentUser === 'red' ? 'blue' : 'red';
                    
                    if (data[otherUser] === 'waiting') {
                        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± Ù…ÙˆØ¬ÙˆØ¯
                        document.getElementById('remoteWaiting').style.display = 'none';
                        
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„Ø§Ù‡Ù…Ø§ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
                        if (data.red === 'waiting' && data.blue === 'waiting') {
                            startCall();
                            roomRef.update({
                                red: 'calling',
                                blue: 'calling'
                            });
                        }
                    } else {
                        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                        document.getElementById('remoteWaiting').style.display = 'flex';
                    }
                }
            }, (error) => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹:', error);
            });
        }

        // ========== Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ==========
        function startCall() {
            createPeerConnection();
            document.getElementById('videoMessage').innerHTML = 'âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
        }

        // ========== Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Peer-to-Peer ==========
        function createPeerConnection() {
            const roomRef = db.collection('rooms').doc(ROOM_ID);
            
            peer = new SimplePeer({
                initiator: currentUser === 'red',  // Ø§Ù„Ø£Ø­Ù…Ø± ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø§ØªØµØ§Ù„
                stream: localStream,
                trickle: false
            });

            peer.on('signal', (data) => {
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                if (currentUser === 'red') {
                    roomRef.update({ offer: JSON.stringify(data) });
                } else {
                    roomRef.update({ answer: JSON.stringify(data) });
                }
            });

            peer.on('stream', (stream) => {
                // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = stream;
                document.getElementById('remoteWaiting').style.display = 'none';
                document.getElementById('videoMessage').innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!';
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                document.getElementById('videoMessage').innerHTML = '<div class="error-message">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Firebase
            roomRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    try {
                        if (currentUser === 'blue' && data.offer && !data.answer) {
                            peer.signal(JSON.parse(data.offer));
                        } else if (currentUser === 'red' && data.answer) {
                            peer.signal(JSON.parse(data.answer));
                        }
                    } catch (e) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:', e);
                    }
                }
            });
        }

        // ========== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª ==========
        function toggleAudio() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isAudioEnabled = !isAudioEnabled;
                document.getElementById('audioBtn').innerHTML = isAudioEnabled ? 'ğŸ”Š ÙƒØªÙ…' : 'ğŸ”‡ ØªØ´ØºÙŠÙ„';
            }
        }

        // ========== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ==========
        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isVideoEnabled = !isVideoEnabled;
                document.getElementById('videoBtn').innerHTML = isVideoEnabled ? 'ğŸ“¹ Ø¥ÙŠÙ‚Ø§Ù' : 'ğŸ“¹ ØªØ´ØºÙŠÙ„';
            }
        }

        // ========== Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© ==========
        async function exitToStart() {
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
            if (roomListener) {
                roomListener();
                roomListener = null;
            }
            
            // Ø¥Ù†Ù‡Ø§Ø¡ Ø§ØªØµØ§Ù„ Peer
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            // Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Firebase
            try {
                await db.collection('rooms').doc(ROOM_ID).delete();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©:', error);
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
            document.getElementById('videoScreen').style.display = 'none';
            document.getElementById('colorScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            currentUser = null;
            
            // ØªÙ†Ø¸ÙŠÙ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£
            document.getElementById('startMessage').innerHTML = '';
            document.getElementById('colorMessage').innerHTML = '';
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¨Ø¹ÙŠØ¯
            document.getElementById('remoteVideo').srcObject = null;
        }

        // ========== ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ ==========
        window.addEventListener('beforeunload', async () => {
            if (currentUser) {
                try {
                    await db.collection('rooms').doc(ROOM_ID).delete();
                } catch (e) {}
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
